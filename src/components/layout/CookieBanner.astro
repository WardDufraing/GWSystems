---
import { analytics } from "../../data/company";

const GA_ID = analytics.ga4MeasurementId;
const AW_ID = analytics.googleAdsId;
---

<dialog class="cookie-dialog" data-cookie-dialog aria-labelledby="cookie-title" aria-describedby="cookie-desc">
  <form method="dialog" class="cookie-dialog__panel">
    <header class="cookie-dialog__header">
      <h2 id="cookie-title" class="cookie-dialog__title">Cookie-instellingen</h2>
      <button type="button" class="cookie-dialog__close" data-cookie-close aria-label="Sluiten">×</button>
    </header>

    <p id="cookie-desc" class="cookie-dialog__text">
      We gebruiken cookies om de website goed te laten werken, anonieme statistieken te verzamelen en (optioneel) marketing te meten.
      Je kan je keuze altijd aanpassen via “Cookie-instellingen”.
    </p>

    <div class="cookie-dialog__options" role="group" aria-label="Cookie categorieën">
      <label class="cookie-dialog__row cookie-dialog__row--locked">
        <input type="checkbox" checked disabled />
        <span>
          <strong>Noodzakelijk</strong><br />
          Nodig om de website correct te laten werken. Altijd ingeschakeld.
        </span>
      </label>

      <label class="cookie-dialog__row">
        <input type="checkbox" data-consent="preferences" />
        <span>
          <strong>Voorkeuren</strong><br />
          Onthoudt je instellingen (bv. voorkeuren of UI-keuzes).
        </span>
      </label>

      <label class="cookie-dialog__row">
        <input type="checkbox" data-consent="statistics" />
        <span>
          <strong>Statistieken</strong><br />
          Helpt ons de site te verbeteren (Google Analytics 4).
        </span>
      </label>

      <label class="cookie-dialog__row">
        <input type="checkbox" data-consent="marketing" />
        <span>
          <strong>Marketing</strong><br />
          Meten van advertenties en prestaties (Google Ads).
        </span>
      </label>
    </div>

    <footer class="cookie-dialog__actions">
      <button type="button" class="btn btn--outline" data-deny-all>Alles weigeren</button>
      <button type="button" class="btn btn--outline" data-save>Voorkeuren opslaan</button>
      <button type="button" class="btn btn--brand" data-accept-all>Alles accepteren</button>
    </footer>

    <p class="cookie-dialog__links">
      <a href="/privacy">Privacy</a> • <a href="/voorwaarden">Voorwaarden</a>
    </p>
  </form>
</dialog>

<script define:vars={{ GA_ID, AW_ID }}>
  (function () {
    // Necessary consent cookie (allowed)
    const COOKIE_NAME = "gw_consent_v1";
    const COOKIE_MAX_AGE_DAYS = 180; // 6 months
    const VERSION = 1;

    const dialog = document.querySelector("[data-cookie-dialog]");
    if (!dialog) return;

    const elPref = dialog.querySelector('[data-consent="preferences"]');
    const elStat = dialog.querySelector('[data-consent="statistics"]');
    const elMkt  = dialog.querySelector('[data-consent="marketing"]');

    const btnAcceptAll = dialog.querySelector("[data-accept-all]");
    const btnDenyAll   = dialog.querySelector("[data-deny-all]");
    const btnSave      = dialog.querySelector("[data-save]");
    const btnClose     = dialog.querySelector("[data-cookie-close]");

    function getCookie(name) {
      const m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      return m ? decodeURIComponent(m[2]) : null;
    }

    function setCookie(name, value, days) {
      const maxAge = days * 24 * 60 * 60;
      document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
    }

    function readConsent() {
      const raw = getCookie(COOKIE_NAME);
      if (!raw) return null;
      try {
        const parsed = JSON.parse(raw);
        if (!parsed || parsed.v !== VERSION) return null;
        return parsed;
      } catch {
        return null;
      }
    }

    function writeConsent(consent) {
      setCookie(COOKIE_NAME, JSON.stringify({ v: VERSION, ...consent, ts: Date.now() }), COOKIE_MAX_AGE_DAYS);
    }

    function applyToGoogle(consent) {
      // Ensure gtag exists (it should from <head>)
      if (typeof window.gtag !== "function") return;

      const analyticsGranted = consent.statistics ? "granted" : "denied";
      const adsGranted       = consent.marketing  ? "granted" : "denied";

      // Consent Mode v2 update (Google doc: default -> update) :contentReference[oaicite:11]{index=11}
      gtag("consent", "update", {
        analytics_storage: analyticsGranted,
        ad_storage: adsGranted,
        ad_user_data: adsGranted,
        ad_personalization: adsGranted
      });

      // If analytics now granted, send the initial page_view we held back
      if (consent.statistics) {
        gtag("event", "page_view");
      }
    }

    function syncUI(consent) {
      elPref.checked = !!consent.preferences;
      elStat.checked = !!consent.statistics;
      elMkt.checked  = !!consent.marketing;
    }

    function openDialog() {
      if (!dialog.open && typeof dialog.showModal === "function") dialog.showModal();
    }

    function closeDialog() {
      if (dialog.open) dialog.close();
    }

    function setConsent(consent) {
      writeConsent(consent);
      applyToGoogle(consent);
      closeDialog();
    }

    // Button handlers
    btnAcceptAll?.addEventListener("click", () => setConsent({ preferences: true, statistics: true, marketing: true }));
    btnDenyAll?.addEventListener("click",   () => setConsent({ preferences: false, statistics: false, marketing: false }));
    btnSave?.addEventListener("click",      () => setConsent({
      preferences: elPref.checked,
      statistics: elStat.checked,
      marketing: elMkt.checked
    }));

    // Close = treat as "deny all" (so we store a choice and don't keep nagging)
    btnClose?.addEventListener("click", () => setConsent({ preferences: false, statistics: false, marketing: false }));

    // Prevent ESC dismiss without recording a choice
    dialog.addEventListener("cancel", (e) => {
      e.preventDefault();
      setConsent({ preferences: false, statistics: false, marketing: false });
    });

    // First load: if existing consent, apply it immediately; else open dialog
    const existing = readConsent();
    if (existing) {
      syncUI(existing);
      applyToGoogle(existing);
    } else {
      // Default UI state = all off (except necessary)
      syncUI({ preferences: false, statistics: false, marketing: false });
      openDialog();
    }

    // Expose global for footer link
    window.gwOpenCookieSettings = function () {
      const current = readConsent() || { preferences: false, statistics: false, marketing: false };
      syncUI(current);
      openDialog();
    };
  })();
</script>